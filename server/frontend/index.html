<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Comment Form</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        form { display: flex; flex-direction: column; }
        label { margin-bottom: 10px; font-weight: bold; }
        textarea { padding: 10px; margin-bottom: 15px; resize: vertical; }
        button { padding: 10px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #status { margin-top: 15px; font-weight: bold; }
        .comment-item { border: 1px solid #ccc; padding: 10px; margin-top: 10px; border-radius: 4px; background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>Leave a Comment on the Product</h1>
    <form id="commentForm">
        <label for="comment">Your Comment:</label>
        <textarea id="comment" name="comment" rows="5" placeholder="Enter your thoughts here..." required></textarea>
        <button type="submit">Submit Comment</button>
    </form>

    <div id="status"></div>

    <h2>Comments</h2>
    <div id="commentsList"></div>

    <script>
        const commentForm = document.getElementById('commentForm');
        const commentsList = document.getElementById('commentsList');
        const statusDiv = document.getElementById('status');
        const webhookUrl = "https://hendrikst.space/n8n/webhook/f69221c8-05f1-4c11-9959-aaba3ec8a282";
        //const webhookUrl = "https://hendrikst.space/n8n/webhook-test/f69221c8-05f1-4c11-9959-aaba3ec8a282";
        const backendUrl = "https://hendrikst.space/n8n-comment-checker/comments";

        async function fetchComments() {
            try {
                const response = await fetch(backendUrl);
                if (response.ok) {
                    const comments = await response.json();
                    commentsList.innerHTML = '';
                    comments.forEach(comment => {
                        const commentElement = document.createElement('div');
                        commentElement.className = 'comment-item';
                        commentElement.textContent = comment.content;

                        const dateElement = document.createElement('small');
                        dateElement.style.display = 'block';
                        dateElement.style.marginTop = '10px';
                        dateElement.style.color = '#666';
                        dateElement.textContent = new Date(comment.date).toLocaleString();
                        commentElement.appendChild(dateElement);

                        commentsList.appendChild(commentElement);
                    });
                }
            } catch (error) {
                console.error('Error fetching comments:', error);
            }
        }

        // Fetch comments on load
        fetchComments();

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const commentText = document.getElementById('comment').value;
            statusDiv.textContent = 'Validating comment...';

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ comment: commentText })
                });

                if (response.ok) {
                    const result = await response.json();

                    // Assuming the workflow returns something like { "valid": true }
                    // or just returns the comment if it's accepted.
                    // If the response is successful, we display the comment.

                    if (result.valid == true) {
                        // Refresh comments list from backend
                        fetchComments();

                        statusDiv.textContent = 'Comment added successfully!';
                        commentForm.reset();
                    } else {
                        statusDiv.textContent = 'Comment rejected by validation.';
                    }
                } else {
                    statusDiv.textContent = 'Error: ' + response.statusText;
                }
            } catch (error) {
                console.error('Error submitting comment:', error);
                statusDiv.textContent = 'Error submitting comment. Please try again.';
            }
        });
    </script>
</body>
</html>
